@import '_global-variables';
@import '_global-mixins';

.chi-popover {
  background-color: $popover-background-color;
  border-radius: $border-radius;
  box-shadow: $popover-box-shadow;
  color: $popover-text-color;
  display: none;
  font-family: $font-family-base;
  font-size: $font-size-base;
  font-weight: $font-weight-normal;
  left: 0;
  line-height: $line-height;
  max-width: $popover-max-width;
  opacity: 0;
  position: absolute;
  text-align: left;
  top: 0;
  white-space: normal;
  z-index: $zindex-popover;

  &.-animated {
    // CSS @keyframes handle show/hide animations via data-state attribute.
    // No CSS transition needed — animations are driven by @keyframes.

    &[data-state='open'] {
      &.chi-popover--top { animation: chi-popover-slide-top-in 0.2s ease forwards; }
      &.chi-popover--top-start { animation: chi-popover-slide-top-in 0.2s ease forwards; }
      &.chi-popover--top-end { animation: chi-popover-slide-top-in 0.2s ease forwards; }
      &.chi-popover--right { animation: chi-popover-slide-right-in 0.2s ease forwards; }
      &.chi-popover--right-start { animation: chi-popover-slide-right-in 0.2s ease forwards; }
      &.chi-popover--right-end { animation: chi-popover-slide-right-in 0.2s ease forwards; }
      &.chi-popover--bottom { animation: chi-popover-slide-bottom-in 0.2s ease forwards; }
      &.chi-popover--bottom-start { animation: chi-popover-slide-bottom-in 0.2s ease forwards; }
      &.chi-popover--bottom-end { animation: chi-popover-slide-bottom-in 0.2s ease forwards; }
      &.chi-popover--left { animation: chi-popover-slide-left-in 0.2s ease forwards; }
      &.chi-popover--left-start { animation: chi-popover-slide-left-in 0.2s ease forwards; }
      &.chi-popover--left-end { animation: chi-popover-slide-left-in 0.2s ease forwards; }
    }

    &[data-state='closed'] {
      &.chi-popover--top { animation: chi-popover-slide-top-out 0.2s ease forwards; }
      &.chi-popover--top-start { animation: chi-popover-slide-top-out 0.2s ease forwards; }
      &.chi-popover--top-end { animation: chi-popover-slide-top-out 0.2s ease forwards; }
      &.chi-popover--right { animation: chi-popover-slide-right-out 0.2s ease forwards; }
      &.chi-popover--right-start { animation: chi-popover-slide-right-out 0.2s ease forwards; }
      &.chi-popover--right-end { animation: chi-popover-slide-right-out 0.2s ease forwards; }
      &.chi-popover--bottom { animation: chi-popover-slide-bottom-out 0.2s ease forwards; }
      &.chi-popover--bottom-start { animation: chi-popover-slide-bottom-out 0.2s ease forwards; }
      &.chi-popover--bottom-end { animation: chi-popover-slide-bottom-out 0.2s ease forwards; }
      &.chi-popover--left { animation: chi-popover-slide-left-out 0.2s ease forwards; }
      &.chi-popover--left-start { animation: chi-popover-slide-left-out 0.2s ease forwards; }
      &.chi-popover--left-end { animation: chi-popover-slide-left-out 0.2s ease forwards; }
    }
  }

  &.-active {
    display: block;
    opacity: 1;
  }

  &.-transitioning {
    display: block;
  }

  & .chi-popover__header {
    border-top-left-radius: $border-radius;
    border-top-right-radius: $border-radius;
    padding: 1rem 1rem 0;

    & .chi-popover__title {
      font-size: $font-size-lg;
      font-weight: $font-weight-semi-bold;
      line-height: $line-height-lg;
      margin: 0;
    }

    & + .chi-popover__content {
      padding: 0.625rem 1rem 1rem;

      & p,
      & .chi-popover__text {
        &:first-child {
          margin-top: 0;
        }

        &:last-child {
          margin-bottom: 0;
        }
      }
    }

    .chi-button {
      &.-close {
        position: absolute;
        right: 0.5rem;
        top: 0.5rem;
      }
    }
  }

  & .chi-popover__content {
    overflow: auto;
    padding: 0.5rem 1rem;

    & .chi-popover__title {
      font-size: $font-size-lg;
      font-weight: $font-weight-semi-bold;
      line-height: $line-height-lg;
      margin: 0.5rem 0;
    }

    & p,
    & .chi-popover__text {
      font-size: $font-size-base;
      line-height: $line-height;
      margin: 0.5rem 0;
    }

    & + .chi-popover__footer {
      padding-top: 0;
    }
  }

  &__input {
    > .chi-popover__content {
      padding: 0;
    }
  }

  & .chi-popover__footer {
    display: flex;
    padding: 1rem;

    & chi-button,
    & .chi-button {
      & + chi-button,
      & + .chi-button {
        margin-left: 0.5rem;
      }
    }

    .chi-divider {
      &.-vertical {
        margin-right: 1rem;
        min-height: 2.5rem;
      }
    }
  }

  // Arrow — positioned by Floating UI's arrow() middleware via inline styles.
  // The arrow div acts as a filter container; its ::before pseudo-element is
  // the visible triangle (a rotated square clipped by clip-path).
  //
  // Clipping strategy:
  //   1. ::before is a square rotated 45° → visual diamond shape
  //   2. clip-path (set via --chi-arrow-clip CSS variable from floating.ts)
  //      removes the inner half that overlaps the popover body

  & .chi-arrow,
  & .chi-popover__arrow {
    display: block;
    height: $popover-arrow-size;
    margin: 0;
    pointer-events: none;
    position: absolute;
    width: $popover-arrow-size;

    &::before {
      background: $popover-background-color;
      clip-path: var(--chi-arrow-clip, polygon(100% 0, 0 100%, 100% 100%));
      content: '';
      display: block;
      height: 100%;
      left: 0;
      position: absolute;
      top: 0;
      transform: rotate(45deg);
      width: 100%;
    }
  }

  // CSS-only fallback arrow positioning for static / documentation usage.
  // When Floating UI runs, its inline styles (higher specificity) override these.
  &.chi-popover--top,
  &.chi-popover--top-start,
  &.chi-popover--top-end {
    .chi-arrow,
    .chi-popover__arrow {
      bottom: calc(#{$popover-arrow-size} / -2);
      left: calc(50% - #{$popover-arrow-size} / 2);
      --chi-arrow-clip: polygon(100% 0, 0 100%, 100% 100%);
    }
  }

  &.chi-popover--bottom,
  &.chi-popover--bottom-start,
  &.chi-popover--bottom-end {
    .chi-arrow,
    .chi-popover__arrow {
      top: calc(#{$popover-arrow-size} / -2);
      left: calc(50% - #{$popover-arrow-size} / 2);
      --chi-arrow-clip: polygon(0 0, 100% 0, 0 100%);
    }
  }

  &.chi-popover--right,
  &.chi-popover--right-start,
  &.chi-popover--right-end {
    .chi-arrow,
    .chi-popover__arrow {
      left: calc(#{$popover-arrow-size} / -2);
      top: calc(50% - #{$popover-arrow-size} / 2);
      --chi-arrow-clip: polygon(0 0, 0 100%, 100% 100%);
    }
  }

  &.chi-popover--left,
  &.chi-popover--left-start,
  &.chi-popover--left-end {
    .chi-arrow,
    .chi-popover__arrow {
      right: calc(#{$popover-arrow-size} / -2);
      top: calc(50% - #{$popover-arrow-size} / 2);
      --chi-arrow-clip: polygon(0 0, 100% 0, 100% 100%);
    }
  }

  &.-closable {
    :not(.chi-popover__header) {
      & + .chi-popover__content {
        padding-top: 2rem;
      }
    }

    header {
      &.chi-popover__header {
        padding-right: 2.5rem;
      }
    }

    chi-button {
      &[type='close'] {
        position: absolute;
        right: 0.5rem;
        top: 0.5rem;

        .chi-button {
          &.-close {
            right: 0;
            top: 0;
          }
        }
      }
    }

    .chi-button {
      &.-close {
        position: absolute;
        right: 0.5rem;
        top: 0.5rem;
      }
    }
  }

  &.-modal {
    background-color: $popover-modal-background-color;
    max-width: 22.5rem;

    .chi-popover__header {
      background-color: $popover-modal-header-background-color;
      background-image: $popover-modal-header-background-image;
      color: $popover-modal-header-text-color;
      padding-bottom: 1rem;
    }

    .chi-popover__content {
      & + .chi-popover__footer {
        padding-top: 1rem;
      }
    }

    .chi-button {
      &.-close {
        &,
        .chi-icon {
          color: $popover-modal-close-icon-color;
        }

        &:hover {
          background: none;
        }
      }
    }

    &.-closable {
      chi-button {
        &[type='close'] {
          top: 1rem;
        }
      }

      .chi-button {
        &.-close {
          top: 1rem;
        }
      }
    }
  }

  .chi-popover__content {
    max-height: 32rem;
  }

  &.-draggable {
    .chi-popover__header {
      cursor: move;

      &::before {
        // sass-lint:disable-all
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 70 6'%3E%3Cpath fill='#{$popover-drag-icon-color}' d='M8 0h2v2H8zm8 0h2v2h-2zm8 0h2v2h-2zM12 0h2v2h-2zm8 0h2v2h-2zm8 0h2v2h-2zM8 4h2v2H8zm8 0h2v2h-2zm8 0h2v2h-2zM12 4h2v2h-2zm8 0h2v2h-2zm8 0h2v2h-2zM0 0h2v2H0zm4 0h2v2H4zM0 4h2v2H0zm4 0h2v2H4zm36-4h2v2h-2zm4 0h2v2h-2zm-4 4h2v2h-2zm4 0h2v2h-2zM32 0h2v2h-2zm4 0h2v2h-2zm-4 4h2v2h-2zm4 0h2v2h-2zm20-4h2v2h-2zm8 0h2v2h-2zm-4 0h2v2h-2zm8 0h2v2h-2zM56 4h2v2h-2zm8 0h2v2h-2zm-4 0h2v2h-2zm8 0h2v2h-2zM48 0h2v2h-2zm4 0h2v2h-2zm-4 4h2v2h-2zm4 0h2v2h-2z'/%3E%3C/svg%3E");
        // sass-lint:enable-all
        background-repeat: no-repeat;
        content: '';
        display: block;
        height: 1rem;
        left: calc(50% - 2.1875rem);
        position: absolute;
        top: 0.3rem;
        width: 4.375rem;
      }
    }
  }

  &.-gradient {
    border-radius: $popover-gradient-border-radius;

    .chi-popover__header {
      border-top-left-radius: $popover-gradient-border-radius;
      border-top-right-radius: $popover-gradient-border-radius;
      background: $popover-gradient-header-background;
      color: $popover-gradient-header-color;
      padding-bottom: $popover-gradient-header-padding-bottom;

      & .chi-popover__title {
        font-size: $popover-gradient-header-title-font-size;
        line-height: $popover-gradient-header-title-line-height;
      }
    }

    .chi-button {
      &.-close {
        top: $popover-gradient-close-button-top;

        &,
        .chi-icon {
          color: $popover-gradient-close-button-icon-color;
        }

        &:hover {
          background: none;
        }
      }
    }

    // Position offsets for left/right start/end placements only.
    // Uses margin-top (not top) to avoid overriding Floating UI's
    // computed inline top value.
    &.chi-popover--right-start,
    &.chi-popover--left-start {
      margin-top: -$popover-gradient-arrow-offset;
    }

    &.chi-popover--right-end,
    &.chi-popover--left-end {
      margin-top: $popover-gradient-arrow-offset;
    }

    /*
    Arrow gradient styles — override the arrow background color
    to match the gradient header/edges per placement direction.
    Floating UI handles all positioning; CSS only sets the color.
    */

    // Right side: arrow matches right edge of gradient header
    &.chi-popover--right,
    &.chi-popover--right-start,
    &.chi-popover--right-end {
      .chi-arrow::before,
      .chi-popover__arrow::before {
        background: $popover-gradient-right-arrow-color;
      }
    }

    // Left side: arrow matches left edge of gradient header
    &.chi-popover--left,
    &.chi-popover--left-start,
    &.chi-popover--left-end {
      .chi-arrow::before,
      .chi-popover__arrow::before {
        background: $popover-gradient-left-arrow-color;
      }
    }

    // Bottom side: arrow uses mixed color (blend of left + right)
    &.chi-popover--bottom,
    &.chi-popover--bottom-start,
    &.chi-popover--bottom-end {
      .chi-arrow::before,
      .chi-popover__arrow::before {
        background: $popover-gradient-arrow-mixed-color;
      }
    }

    // Align arrow to gradient for gradient use case
    &.chi-popover--left,
    &.chi-popover--right {
      .chi-arrow,
      .chi-popover__arrow {
        margin-top: -1.75rem;
      }
    }

    &.chi-popover--left-start,
    &.chi-popover--right-start {
      .chi-arrow,
      .chi-popover__arrow {
        margin-top: 0.75rem;
      }
    }
  }
}

// @keyframes for popover show/hide animations.
// Uses transform: none in the final keyframe (not translateY(0))
// to avoid creating a CSS containing block that would trap nested
// position: fixed elements.

@keyframes chi-popover-slide-top-in {
  from { opacity: 0; transform: translateY(20px); }
  to { opacity: 1; transform: none; }
}

@keyframes chi-popover-slide-top-out {
  from { opacity: 1; transform: none; }
  to { opacity: 0; transform: translateY(20px); }
}

@keyframes chi-popover-slide-bottom-in {
  from { opacity: 0; transform: translateY(-20px); }
  to { opacity: 1; transform: none; }
}

@keyframes chi-popover-slide-bottom-out {
  from { opacity: 1; transform: none; }
  to { opacity: 0; transform: translateY(-20px); }
}

@keyframes chi-popover-slide-right-in {
  from { opacity: 0; transform: translateX(-20px); }
  to { opacity: 1; transform: none; }
}

@keyframes chi-popover-slide-right-out {
  from { opacity: 1; transform: none; }
  to { opacity: 0; transform: translateX(-20px); }
}

@keyframes chi-popover-slide-left-in {
  from { opacity: 0; transform: translateX(20px); }
  to { opacity: 1; transform: none; }
}

@keyframes chi-popover-slide-left-out {
  from { opacity: 1; transform: none; }
  to { opacity: 0; transform: translateX(20px); }
}

chi-popover {
  &:not(.hydrated) {
    &:not([active]) {
      display: none;
    }
  }
}
